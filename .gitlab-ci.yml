stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: wrakash/sky-gateway
  HELM_CHART_PATH: helm

# Test all services
test:
  stage: test
  image: node:20-alpine
  script:
    # --- API-GATEWAY ---
    - cd api-gateway
    - npm install
    - npm audit fix --force || true
    - npm test || echo "No tests or skipped"
    - cd ..

    # --- SERVICE1 ---
    - cd service1
    - npm install
    - npm audit fix --force || true
    - npm test || echo "No tests or skipped"
    - cd ..

    # --- SERVICE2 ---
    - cd service2
    - npm install
    - npm audit fix --force || true
    - npm test || echo "No tests or skipped"
    - cd ..
  only:
    - main
    - master
    - develop
    - merge_requests

# Build Docker Image
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_TOKEN"
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
  only:
    - main
    - master
    - tags

# Deploy using Helm
deploy:
  stage: deploy
  image: alpine/helm:3.12.0
  dependencies:
    - build
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG" | base64 -d > ~/.kube/config
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - helm upgrade --install api-gateway helm \
        --namespace default \
        --set image.repository=$IMAGE_NAME \
        --set image.tag=$IMAGE_TAG \
        --wait \
        --timeout 5m
  environment:
    name: production
  when: manual
  only:
    - main
