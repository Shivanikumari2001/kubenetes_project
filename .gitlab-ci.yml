stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_NAME: shivani0320/sky-gateway   # <-- apna Docker Hub username lagao
  HELM_CHART_PATH: api-gateway/helm     # <-- agar Helm chart api-gateway ke andar hai

# Test all services
test:
  stage: test
  image: node:20-alpine
  script:
    - cd api-gateway && npm install && npm audit fix --force || true && npm test || echo "No tests or skipped" && cd ..
    - cd service1 && npm install && npm audit fix --force || true && npm test || echo "No tests or skipped" && cd ..
    - cd service2 && npm install && npm audit fix --force || true && npm test || echo "No tests or skipped" && cd ..
  only:
    - main
    - master
    - develop
    - merge_requests

# Build Docker Image (only API-Gateway)
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USER" --password-stdin
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - docker build -t $IMAGE_NAME:$IMAGE_TAG ./api-gateway   # <-- correct path
    - docker push $IMAGE_NAME:$IMAGE_TAG
  only:
    - main
    - master
    - tags

# Deploy using Helm
deploy:
  stage: deploy
  image: alpine/helm:3.12.0
  dependencies:
    - build
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG" | base64 -d > ~/.kube/config
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - helm upgrade --install api-gateway ./api-gateway/helm \   # <-- correct path
        --namespace default \
        --set image.repository=$IMAGE_NAME \
        --set image.tag=$IMAGE_TAG \
        --wait \
        --timeout 5m
  environment:
    name: production
  when: manual
  only:
    - main

