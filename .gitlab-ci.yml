stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: wrakash/sky-gateway
  HELM_CHART_PATH: helm

# Cache node_modules for faster builds
cache:
  paths:
    - node_modules/

# Test stage
test:
  stage: test
  image: node:20-alpine
  before_script:
    - npm ci
  script:
    - npm run lint
    - npm run test
  only:
    - merge_requests
    - main
    - master
    - develop

# Build Docker image
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - |
      if [ -z "$CI_REGISTRY" ]; then
        docker login -u "$DOCKER_HUB_USER" -p "$DOCKER_HUB_TOKEN"
      else
        docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
      fi
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - export FULL_IMAGE_NAME=${CI_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
    - docker build -t $FULL_IMAGE_NAME .
    - docker tag $FULL_IMAGE_NAME ${CI_REGISTRY}/${IMAGE_NAME}:latest
    - docker push $FULL_IMAGE_NAME
    - docker push ${CI_REGISTRY}/${IMAGE_NAME}:latest
    - echo "IMAGE_TAG=$IMAGE_TAG" > build.env
    - echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    - main
    - master
    - develop
    - tags

# Deploy to Kubernetes via Helm
deploy:
  stage: deploy
  image: alpine/helm:3.12.0
  dependencies:
    - build
  before_script:
    - apk add --no-cache git
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG" | base64 -d > ~/.kube/config
    - kubectl version --client
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - echo "Deploying with image: $IMAGE_NAME:$IMAGE_TAG"
    - helm upgrade --install api-gateway $HELM_CHART_PATH \
        --namespace default \
        --create-namespace \
        --set image.repository=${IMAGE_NAME} \
        --set image.tag=${IMAGE_TAG} \
        --wait \
        --timeout 5m
  environment:
    name: production
    url: http://api-gateway.default
  only:
    - main
    - master
  when: manual

# Update Helm chart and commit (for ArgoCD)
update-helm-chart:
  stage: deploy
  image: alpine/git:latest
  before_script:
    - apk add --no-cache yq
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    - git remote set-url origin https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
  script:
    - export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
    - |
      if command -v yq &> /dev/null; then
        yq eval ".image.tag = \"$IMAGE_TAG\"" -i $HELM_CHART_PATH/values.yaml
      else
        sed -i "s/^  tag:.*/  tag: \"$IMAGE_TAG\"/" $HELM_CHART_PATH/values.yaml
      fi
    - git add $HELM_CHART_PATH/values.yaml
    - git commit -m "chore: update image tag to $IMAGE_TAG [skip ci]" || echo "No changes to commit"
    - git push origin HEAD:${CI_COMMIT_REF_NAME} || echo "Push failed or no changes"
  only:
    - main
    - master
  when: manual
